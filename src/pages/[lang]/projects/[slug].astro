---
import { getCollection } from "astro:content";
import Layout from "../../../layouts/Layout.astro";
import Navbar from "../../../components/Navbar.astro";
import { getLangFromUrl, useTranslations } from "../../../i18n/utils";

const { slug } = Astro.params;
const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

// Find the project matching the slug + language
const allProjects = await getCollection("projects");
const project = allProjects.find((p) => {
  const projectSlug = p.slug.split("/").pop();
  return projectSlug === slug && p.data.lang === lang;
});

if (!project) {
  return Astro.redirect(`/${lang}/projects`);
}

const { Content } = await project.render();
const {
  title,
  description,
  tagline,
  image,
  technologies,
  github,
  demo,
  sections,
} = project.data;

// Parse a body string: split on newlines, render lists or paragraphs
function parseBody(body: string): string {
  // YAML double-quoted strings parse \n as real newlines; split on both
  const lines = body
    .split(/\n|\\n/)
    .map((l) => l.trim())
    .filter(Boolean);
  const isListLine = (l: string) =>
    l.startsWith("- ") || l.startsWith("\u2013 ");
  const allList = lines.every(isListLine);
  if (allList) {
    const items = lines
      .map((l) => `<li>${l.replace(/^[-\u2013]\s*/, "")}</li>`)
      .join("");
    return `<ul>${items}</ul>`;
  }
  return lines
    .map((l) =>
      isListLine(l)
        ? `<li>${l.replace(/^[-\u2013]\s*/, "")}</li>`
        : `<p>${l}</p>`,
    )
    .join("");
}
---

<Layout title={title}>
  <Navbar />
  <main class="container">
    <!-- Back button -->
    <a href={`/${lang}#projects`} class="back-link">
      ← {t("nav.projects")}
    </a>

    <!-- Project header -->
    <header class="project-header">
      <div class="header-meta">
        {tagline && <p class="project-tagline">{tagline}</p>}
        <h1 class="project-title">{title}</h1>
        <p class="project-desc">{description}</p>
      </div>

      <!-- Hero image -->
      {
        image && (
          <div class="hero-image-wrapper">
            <img src={image} alt={title} class="hero-image" />
          </div>
        )
      }

      <!-- Technologies -->
      <div class="tech-tags">
        {technologies.map((tech) => <span class="tech-tag">{tech}</span>)}
      </div>

      <!-- Links -->
      <div class="project-links">
        {
          github && (
            <a
              href={github}
              target="_blank"
              rel="noopener noreferrer"
              class="link-btn link-github"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="currentColor"
              >
                <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z" />
              </svg>
              GitHub
            </a>
          )
        }
        {
          demo && (
            <a
              href={demo}
              target="_blank"
              rel="noopener noreferrer"
              class="link-btn link-demo"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2.5"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6" />
                <polyline points="15 3 21 3 21 9" />
                <line x1="10" y1="14" x2="21" y2="3" />
              </svg>
              {t("projects.viewDemo")}
            </a>
          )
        }
      </div>
    </header>

    <!-- Sections -->
    {
      sections && sections.length > 0 && (
        <div class="sections-wrapper">
          {sections.map((section, i) => {
            const layout = section.layout || "image-right";
            const isTextOnly = layout === "text-only";
            const isImageOnly = layout === "image-only";
            const imageLeft = layout === "image-left";

            return (
              <section
                class={`project-section section-${layout} ${i % 2 === 0 ? "section-even" : "section-odd"}`}
              >
                {isTextOnly ? (
                  <div class="section-text-only">
                    {section.title && (
                      <h2 class="section-title">{section.title}</h2>
                    )}
                    {section.body && (
                      <div
                        class="section-body"
                        set:html={parseBody(section.body)}
                      />
                    )}
                  </div>
                ) : isImageOnly ? (
                  <div class="section-image-block">
                    {section.image && (
                      <img
                        src={section.image}
                        alt={section.imageAlt || ""}
                        class="section-img"
                      />
                    )}
                    {section.imageCaption && (
                      <p class="section-caption">{section.imageCaption}</p>
                    )}
                  </div>
                ) : (
                  <div
                    class={`section-split ${imageLeft ? "split-image-left" : "split-image-right"}`}
                  >
                    <div class="section-text-block">
                      {section.title && (
                        <h2 class="section-title">{section.title}</h2>
                      )}
                      {section.body && (
                        <div
                          class="section-body"
                          set:html={parseBody(section.body)}
                        />
                      )}
                    </div>
                    <div class="section-image-block">
                      {section.image && (
                        <figure>
                          <img
                            src={section.image}
                            alt={section.imageAlt || ""}
                            class="section-img"
                          />
                          {section.imageCaption && (
                            <figcaption class="section-caption">
                              {section.imageCaption}
                            </figcaption>
                          )}
                        </figure>
                      )}
                    </div>
                  </div>
                )}
              </section>
            );
          })}
        </div>
      )
    }

    <!-- Fallback: raw markdown content -->
    <article class="prose-content">
      <Content />
    </article>
  </main>
</Layout>

<style>
  @reference "../../../styles/global.css";

  .container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 120px 40px 100px;
  }

  /* ─── Back link ─── */
  .back-link {
    display: inline-block;
    margin-bottom: 32px;
    font-family: var(--font-jakarta, sans-serif);
    font-size: 13px;
    color: var(--color-text-secondary, #626262);
    text-decoration: none;
    transition: color 0.2s ease;
    letter-spacing: 0.01em;
  }
  .back-link:hover {
    color: var(--color-text-primary, #3d3d3d);
  }

  /* ─── Project Header ─── */
  .project-header {
    margin-bottom: 80px;
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
  }

  .header-meta {
    margin-bottom: 28px;
  }

  .project-tagline {
    font-family: var(--font-jetbrains, monospace);
    font-size: 12px;
    font-weight: 600;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    color: var(--color-text-accent, #6b705c);
    margin-bottom: 10px;
  }

  .project-title {
    font-family: var(--font-fraunces, serif);
    font-size: 42px;
    font-weight: 700;
    color: var(--color-text-primary, #3d3d3d);
    margin-bottom: 14px;
    line-height: 1.15;
  }

  .project-desc {
    font-family: var(--font-jakarta, sans-serif);
    font-size: 16px;
    color: var(--color-text-secondary, #626262);
    line-height: 1.7;
    max-width: 680px;
  }

  /* ─── Hero Image ─── */
  .hero-image-wrapper {
    width: 100%;
    aspect-ratio: 16 / 9;
    overflow: hidden;
    border-radius: 16px;
    margin-bottom: 28px;
    border: 1.5px solid #e2ddd6;
  }

  .hero-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
  }

  /* ─── Tech Tags ─── */
  .tech-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-bottom: 24px;
  }

  .tech-tag {
    padding: 5px 14px;
    border: 1.5px solid var(--color-text-primary, #3d3d3d);
    border-radius: 999px;
    font-family: var(--font-jetbrains, monospace);
    font-size: 11px;
    font-weight: 500;
    color: var(--color-text-primary, #3d3d3d);
    letter-spacing: 0.02em;
  }

  /* ─── Links ─── */
  .project-links {
    display: flex;
    gap: 12px;
  }

  .link-btn {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 10px 22px;
    border-radius: 999px;
    font-family: var(--font-jetbrains, monospace);
    font-size: 13px;
    font-weight: 700;
    letter-spacing: 0.04em;
    text-decoration: none;
    transition:
      opacity 0.2s ease,
      transform 0.15s ease;
  }

  .link-btn:hover {
    opacity: 0.82;
    transform: translateY(-1px);
  }

  .link-github {
    background: var(--color-buttons, #3d3d3d);
    color: var(--color-text-buttons, #f4f1ea);
  }

  .link-demo {
    background: transparent;
    color: var(--color-text-primary, #3d3d3d);
    border: 1.5px solid var(--color-text-primary, #3d3d3d);
  }

  /* ─── Sections ─── */
  .sections-wrapper {
    display: flex;
    flex-direction: column;
    gap: 0;
  }

  .project-section {
    padding: 48px 0;
    border-top: 1px solid #e2ddd6;
  }

  /* Split layout (image-left / image-right) */
  .section-split {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 40px;
    align-items: center;
  }

  .split-image-left {
    direction: rtl;
  }
  .split-image-left > * {
    direction: ltr;
  }

  .section-title {
    font-family: var(--font-fraunces, serif);
    font-size: 24px;
    font-weight: 700;
    color: var(--color-text-primary, #3d3d3d);
    margin-bottom: 14px;
    line-height: 1.25;
  }

  .section-body {
    font-family: var(--font-jakarta, sans-serif);
    font-size: 15px;
    line-height: 1.72;
    color: var(--color-text-secondary, #626262);
  }

  .section-body :global(p) {
    margin-bottom: 12px;
  }

  .section-body :global(ul) {
    list-style: none;
    padding: 0;
    margin: 0;
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .section-body :global(li) {
    padding-left: 20px;
    position: relative;
  }

  .section-body :global(li)::before {
    content: "→";
    position: absolute;
    left: 0;
    color: var(--color-text-accent, #6b705c);
    font-weight: 700;
    font-family: var(--font-jetbrains, monospace);
  }

  /* Image block */
  .section-image-block figure {
    margin: 0;
  }

  .section-img {
    width: 100%;
    aspect-ratio: 4 / 3;
    object-fit: cover;
    border-radius: 12px;
    display: block;
    border: 1.5px solid #e2ddd6;
  }

  .section-caption {
    font-family: var(--font-jetbrains, monospace);
    font-size: 11px;
    color: var(--color-text-secondary, #626262);
    margin-top: 10px;
    letter-spacing: 0.02em;
    text-align: center;
  }

  /* Text-only layout */
  .section-text-only {
    max-width: 720px;
  }

  /* Alternating even/odd background tint */
  .section-odd {
    background: transparent;
  }

  /* ─── Responsive ─── */
  @media (max-width: 680px) {
    .project-title {
      font-size: 30px;
    }

    .section-split {
      grid-template-columns: 1fr;
    }

    .split-image-left {
      direction: ltr;
    }

    .section-image-block {
      order: -1;
    }
  }

  /* ─── Prose fallback (empty if no raw markdown body) ─── */
  .prose-content:empty {
    display: none;
  }

  .prose-content :global(h2) {
    font-family: var(--font-fraunces, serif);
    font-size: 22px;
    font-weight: 600;
    color: var(--color-text-primary, #3d3d3d);
    margin-top: 32px;
    margin-bottom: 12px;
  }

  .prose-content :global(p) {
    font-family: var(--font-jakarta, sans-serif);
    font-size: 15px;
    line-height: 1.7;
    color: var(--color-text-secondary, #626262);
    margin-bottom: 14px;
  }

  .prose-content :global(ul) {
    list-style: disc;
    padding-left: 24px;
    margin-bottom: 16px;
  }

  .prose-content :global(li) {
    font-family: var(--font-jakarta, sans-serif);
    font-size: 15px;
    line-height: 1.65;
    color: var(--color-text-secondary, #626262);
    margin-bottom: 6px;
  }
</style>
