---
import {
  getLangFromUrl,
  useTranslations,
  useTranslatedPath,
} from "../i18n/utils";
import { languages } from "../i18n/ui";

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);
const translatePath = useTranslatedPath(lang);

const currentLangLabel = languages[lang as keyof typeof languages];
---

<!-- ===== DESKTOP NAVBAR ===== -->
<nav
  id="navbar"
  class="bg-primary-blur backdrop-blur-xs fixed w-full top-0 z-50 border-b border-text-primary/10"
>
  <div
    class="container mx-auto flex flex-row justify-between items-center py-3 px-6"
  >
    <!-- Brand -->
    <a
      href={`/${lang}`}
      class="font-fraunces text-base text-text-primary font-bold tracking-widest uppercase select-none"
    >
      José Montaño
    </a>

    <!-- Desktop nav links -->
    <ul class="hidden md:flex flex-row items-center gap-8">
      <li>
        <a
          href={`/${lang}#projects`}
          class="nav-link font-jakarta text-xs font-semibold text-text-secondary uppercase tracking-widest hover:text-text-primary transition-colors duration-200 relative group"
        >
          {t("nav.projects")}
          <span
            class="absolute -bottom-0.5 left-0 w-0 h-px bg-text-primary transition-all duration-300 group-hover:w-full"
          ></span>
        </a>
      </li>
      <li>
        <a
          href={`/${lang}#technologies`}
          class="nav-link font-jakarta text-xs font-semibold text-text-secondary uppercase tracking-widest hover:text-text-primary transition-colors duration-200 relative group"
        >
          {t("nav.technologies")}
          <span
            class="absolute -bottom-0.5 left-0 w-0 h-px bg-text-primary transition-all duration-300 group-hover:w-full"
          ></span>
        </a>
      </li>
      <li>
        <a
          href={`/${lang}#about`}
          class="nav-link font-jakarta text-xs font-semibold text-text-secondary uppercase tracking-widest hover:text-text-primary transition-colors duration-200 relative group"
        >
          {t("nav.about")}
          <span
            class="absolute -bottom-0.5 left-0 w-0 h-px bg-text-primary transition-all duration-300 group-hover:w-full"
          ></span>
        </a>
      </li>
      <li>
        <a
          href={`/${lang}#contact`}
          class="nav-link font-jakarta text-xs font-semibold text-text-secondary uppercase tracking-widest hover:text-text-primary transition-colors duration-200 relative group"
        >
          {t("nav.contact")}
          <span
            class="absolute -bottom-0.5 left-0 w-0 h-px bg-text-primary transition-all duration-300 group-hover:w-full"
          ></span>
        </a>
      </li>

      <!-- Desktop language dropdown -->
      <li class="relative" id="lang-dropdown-wrapper">
        <button
          id="lang-dropdown-btn"
          class="flex items-center gap-1.5 font-jakarta text-xs font-semibold text-text-secondary uppercase tracking-widest hover:text-text-primary transition-colors duration-200 group cursor-pointer select-none"
          aria-haspopup="listbox"
          aria-expanded="false"
        >
          <!-- Globe icon -->
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="14"
            height="14"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            class="opacity-70 group-hover:opacity-100 transition-opacity"
          >
            <circle cx="12" cy="12" r="10"></circle>
            <path d="M12 2a14.5 14.5 0 0 0 0 20 14.5 14.5 0 0 0 0-20"></path>
            <path d="M2 12h20"></path>
          </svg>
          <span id="lang-label">{currentLangLabel}</span>
          <!-- Chevron -->
          <svg
            id="lang-chevron"
            xmlns="http://www.w3.org/2000/svg"
            width="10"
            height="10"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2.5"
            stroke-linecap="round"
            stroke-linejoin="round"
            class="transition-transform duration-200"
          >
            <path d="m6 9 6 6 6-6"></path>
          </svg>
        </button>

        <!-- Dropdown panel -->
        <ul
          id="lang-dropdown"
          role="listbox"
          class="absolute right-0 top-[calc(100%+10px)] min-w-[130px] bg-primary border border-text-primary/15 rounded-xl shadow-lg overflow-hidden opacity-0 scale-95 pointer-events-none transition-all duration-200 origin-top-right"
        >
          {
            Object.entries(languages).map(([code, label]) => (
              <li role="option">
                <a
                  href={translatePath("/", code)}
                  class={`flex items-center gap-2 px-4 py-2.5 font-jakarta text-xs font-semibold uppercase tracking-widest transition-colors duration-150
                  ${
                    code === lang
                      ? "text-text-primary bg-text-primary/8"
                      : "text-text-secondary hover:text-text-primary hover:bg-text-primary/5"
                  }`}
                >
                  {code === lang && (
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      width="10"
                      height="10"
                      viewBox="0 0 24 24"
                      fill="currentColor"
                      class="shrink-0"
                    >
                      <path d="M20.285 6.709a1 1 0 0 0-1.414 0L9 16.58l-4.871-4.871a1 1 0 0 0-1.414 1.414l5.578 5.578a1 1 0 0 0 1.414 0l10.578-10.578a1 1 0 0 0 0-1.414Z" />
                    </svg>
                  )}
                  {code !== lang && <span class="w-[10px] shrink-0" />}
                  {label}
                </a>
              </li>
            ))
          }
        </ul>
      </li>
    </ul>

    <!-- Mobile: hamburger button -->
    <button
      id="hamburger-btn"
      class="md:hidden flex flex-col justify-center items-center w-8 h-8 gap-[5px] z-[60] relative cursor-pointer"
      aria-label="Toggle menu"
      aria-expanded="false"
    >
      <span
        id="bar1"
        class="block w-5 h-[1.5px] bg-text-primary transition-all duration-300 origin-center"
      ></span>
      <span
        id="bar2"
        class="block w-5 h-[1.5px] bg-text-primary transition-all duration-300"
      ></span>
      <span
        id="bar3"
        class="block w-5 h-[1.5px] bg-text-primary transition-all duration-300 origin-center"
      ></span>
    </button>
  </div>
</nav>

<div
  id="mobile-menu"
  class="fixed inset-0 z-40 flex flex-col bg-primary opacity-0 pointer-events-none transition-opacity duration-300 md:hidden"
>

  <ul class="flex flex-col items-center justify-center flex-1 gap-8">
    <li>
      <a
        href={`/${lang}#projects`}
        class="mobile-link font-jakarta text-2xl font-semibold text-text-primary uppercase tracking-widest hover:text-text-accent transition-colors duration-200"
      >
        {t("nav.projects")}
      </a>
    </li>
    <li>
      <a
        href={`/${lang}#technologies`}
        class="mobile-link font-jakarta text-2xl font-semibold text-text-primary uppercase tracking-widest hover:text-text-accent transition-colors duration-200"
      >
        {t("nav.technologies")}
      </a>
    </li>
    <li>
      <a
        href={`/${lang}#about`}
        class="mobile-link font-jakarta text-2xl font-semibold text-text-primary uppercase tracking-widest hover:text-text-accent transition-colors duration-200"
      >
        {t("nav.about")}
      </a>
    </li>
    <li>
      <a
        href={`/${lang}#contact`}
        class="mobile-link font-jakarta text-2xl font-semibold text-text-primary uppercase tracking-widest hover:text-text-accent transition-colors duration-200"
      >
        {t("nav.contact")}
      </a>
    </li>

    <li class="flex items-center gap-3 mt-2">
      {
        Object.entries(languages).map(([code, label]) => (
          <a
            href={translatePath("/", code)}
            class={`font-jakarta text-xs font-bold uppercase tracking-widest px-4 py-2 rounded-full border transition-all duration-200
            ${
              code === lang
                ? "bg-text-primary text-primary border-text-primary"
                : "bg-transparent text-text-secondary border-text-primary/30 hover:border-text-primary hover:text-text-primary"
            }`}
          >
            {label}
          </a>
        ))
      }
    </li>
  </ul>
</div>

<script>
  // ── Hamburger menu ──────────────────────────────────────────
  const btn = document.getElementById("hamburger-btn")!;
  const menu = document.getElementById("mobile-menu")!;
  const bar1 = document.getElementById("bar1")!;
  const bar2 = document.getElementById("bar2")!;
  const bar3 = document.getElementById("bar3")!;
  let menuOpen = false;

  function openMenu() {
    menuOpen = true;
    menu.classList.remove("opacity-0", "pointer-events-none");
    menu.classList.add("opacity-100");
    btn.setAttribute("aria-expanded", "true");
    bar1.style.transform = "translateY(6.5px) rotate(45deg)";
    bar2.style.opacity = "0";
    bar3.style.transform = "translateY(-6.5px) rotate(-45deg)";
    document.body.style.overflow = "hidden";
  }

  function closeMenu() {
    menuOpen = false;
    menu.classList.remove("opacity-100");
    menu.classList.add("opacity-0", "pointer-events-none");
    btn.setAttribute("aria-expanded", "false");
    bar1.style.transform = "";
    bar2.style.opacity = "";
    bar3.style.transform = "";
    document.body.style.overflow = "";
  }

  btn.addEventListener("click", () => (menuOpen ? closeMenu() : openMenu()));
  document
    .querySelectorAll(".mobile-link")
    .forEach((l) => l.addEventListener("click", closeMenu));

  // ── Language dropdown ───────────────────────────────────────
  const dropBtn = document.getElementById("lang-dropdown-btn")!;
  const drop = document.getElementById("lang-dropdown")!;
  const chevron = document.getElementById("lang-chevron")!;
  let dropOpen = false;

  function openDrop() {
    dropOpen = true;
    drop.classList.remove("opacity-0", "scale-95", "pointer-events-none");
    drop.classList.add("opacity-100", "scale-100");
    chevron.style.transform = "rotate(180deg)";
    dropBtn.setAttribute("aria-expanded", "true");
  }

  function closeDrop() {
    dropOpen = false;
    drop.classList.remove("opacity-100", "scale-100");
    drop.classList.add("opacity-0", "scale-95", "pointer-events-none");
    chevron.style.transform = "";
    dropBtn.setAttribute("aria-expanded", "false");
  }

  dropBtn.addEventListener("click", (e) => {
    e.stopPropagation();
    dropOpen ? closeDrop() : openDrop();
  });

  // Close dropdown when clicking outside
  document.addEventListener("click", (e) => {
    if (
      dropOpen &&
      !document
        .getElementById("lang-dropdown-wrapper")!
        .contains(e.target as Node)
    ) {
      closeDrop();
    }
  });
</script>
